<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Market Spoofing Simulation</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- import map: Chart.js ESM -->
<script type="importmap">
{
  "imports": {
    "chart.js": "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.mjs"
  }
}
</script>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Arial;margin:12px;background:#f6f7fb;color:#122}
  .app{display:grid;grid-template-columns:360px 1fr 360px;gap:12px}
  .panel{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(8,10,30,.06)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #orderbook{height:320px;display:flex;flex-direction:column;gap:6px;overflow:auto}
  .ob-row{display:flex;justify-content:space-between;font-size:13px;padding:4px 6px;border-radius:4px}
  .ask{background:#fff4f4;color:#8b1e1e} .bid{background:#f4fff9;color:#0b6b3a}
  /* Charts panel + person monitor styles */
  .charts{display:flex;gap:8px;height:320px}
  .chart-canvas{flex:1;background:#fff;padding:6px;border-radius:6px}
  .person-monitor{width:160px;height:120px;background:linear-gradient(180deg,#0b1324 0%,#0b1b2b 100%);border-radius:8px;padding:8px;color:#cfe8ff;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(2,6,23,.25)}
  .person-svg{width:160px;height:160px;display:block;margin:6px auto 0}
  .controls{display:flex;gap:8px;margin-top:8px}
  button{padding:8px 12px;border-radius:6px;border:0;background:#0b5fff;color:#fff;cursor:pointer}
  button.warn{background:#ff5b5b}
  small{color:#667}
  .timeline{margin-top:10px;font-size:13px;max-height:120px;overflow:auto}
</style>
</head>
<body>
<div class="app">
  <!-- Left: Actors / Controls -->
  <div class="panel" id="actors">
    <header><h3>Actors</h3><small>Investor & Market Makers</small></header>
    <div id="investor"><strong>Investor:</strong> Alice (victim)</div>
    <div id="market-maker"><strong>Maker:</strong> ShadowPool</div>
    <div class="controls">
      <button id="buyBtn">Buy 100</button>
      <button id="sellBtn" class="warn">Sell 100</button>
      <button id="spoofBtn" class="warn" title="Trigger spoofing">Trigger Spoof</button>
    </div>
    <div class="timeline" id="timeline"></div>
  </div>

  <!-- Middle: Order Book + Trade Charts -->
  <div class="panel" id="main">
    <header><h3>Order Book</h3><small>Live bids & asks</small></header>
    <div id="orderbook">
      <!-- Minimal existing actors preserved, add canvases in order book panel -->
      <div id="ob-canvases" style="display:flex;gap:8px;margin-bottom:6px">
        <div style="flex:1" class="chart-canvas"><canvas id="miniOB"></canvas></div>
      </div>
      <!-- order lines -->
    </div>

    <header style="margin-top:10px"><h3>Trade Charts</h3><small>Buys vs Sells</small></header>
    <div class="charts">
      <div class="chart-canvas"><canvas id="buyChart"></canvas></div>
      <div class="chart-canvas"><canvas id="sellChart"></canvas></div>
    </div>
  </div>

  <!-- Right: Person monitor with SVG -->
  <div class="panel" id="right">
    <header><h3>Observer</h3><small>Person watching</small></header>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="person-monitor" id="monitor">
        <!-- small live chart inside monitor -->
        <canvas id="monitorChart" width="140" height="80" style="background:linear-gradient(180deg,#071022,#052036);border-radius:6px"></canvas>
      </div>
      <!-- simple SVG person -->
      <svg class="person-svg" viewBox="0 0 64 64" aria-hidden>
        <g fill="none" stroke="#222" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="32" cy="16" r="8" fill="#ffd9b3" stroke="none"/>
          <path d="M16 50c4-12 8-16 16-16s12 4 16 16" stroke="#3b3f45" stroke-width="2"/>
          <rect x="8" y="36" width="48" height="18" rx="3" fill="#0b5fff" opacity=".08"/>
        </g>
      </svg>
    </div>
  </div>
</div>

<!-- minimal script with import at top and concise logic -->
<script type="module">
import { Chart, registerables } from 'chart.js';
Chart.register(...registerables);

const buys=[]; const sells=[]; const timeline=document.getElementById('timeline');
function randPrice(){return +(100 + (Math.random()*4 - 2)).toFixed(2);}
function log(msg){const el=document.createElement('div');el.textContent=msg;timeline.prepend(el);}

// initialize charts
const buyCtx = document.getElementById('buyChart').getContext('2d');
const sellCtx = document.getElementById('sellChart').getContext('2d');
const monCtx = document.getElementById('monitorChart').getContext('2d');
const miniCtx = document.getElementById('miniOB').getContext('2d');

const buyChart = new Chart(buyCtx,{type:'line',data:{labels:[],datasets:[{label:'Buys',borderColor:'#0b7',backgroundColor:'rgba(11,119,85,.08)',data:[]}]},options:{animation:false,scales:{x:{display:false}}}});
const sellChart= new Chart(sellCtx,{type:'line',data:{labels:[],datasets:[{label:'Sells',borderColor:'#f33',backgroundColor:'rgba(255,59,59,.06)',data:[]}]},options:{animation:false,scales:{x:{display:false}}}});
const monitorChart=new Chart(monCtx,{type:'line',data:{labels:[],datasets:[{label:'Mini',borderColor:'#9cf',data:[]}]},options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
const miniOB=new Chart(miniCtx,{type:'bar',data:{labels:['Bid','Ask'],datasets:[{data:[0,0],backgroundColor:['#0b6b3a','#8b1e1e']}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false}}}});

// helper to push trades and update charts
function addTrade(side,qty,price,actor='Alice'){
  const t={time:new Date().toLocaleTimeString(),side,qty,price,actor};
  log(`${t.time} ${actor} ${side.toUpperCase()} ${qty}@${price}`);
  if(side==='buy'){buys.push(t); buyChart.data.labels.push(''); buyChart.data.datasets[0].data.push(price); }
  else {sells.push(t); sellChart.data.labels.push(''); sellChart.data.datasets[0].data.push(price); }
  // monitor shows last few price points (merged)
  const merged = buys.slice(-20).concat(sells.slice(-20)).map(x=>x.price);
  monitorChart.data.labels = merged.map((_,i)=>i);
  monitorChart.data.datasets[0].data = merged;
  // mini OB simulate imbalance
  miniOB.data.datasets[0].data = [Math.max(0,buys.length - sells.length), Math.max(0,sells.length - buys.length)];
  buyChart.update(); sellChart.update(); monitorChart.update(); miniOB.update();
}

// preserve existing buy/sell functions (minimal changes) and hook charts
document.getElementById('buyBtn').addEventListener('click',()=>{addTrade('buy',100,randPrice());});
document.getElementById('sellBtn').addEventListener('click',()=>{addTrade('sell',100,randPrice());});

// spoofing simulation: place deceptive large orders then cancel -> victim forced to react
document.getElementById('spoofBtn').addEventListener('click', async ()=>{
  log('‚ö†Ô∏è ShadowPool placing large spoof asks...');
  // show many fake asks (no actual orderbook implementation; we simulate victim acting)
  for(let i=0;i<6;i++){await new Promise(r=>setTimeout(r,220)); addTrade('sell',500,+(102 + i*0.4).toFixed(2),'ShadowPool');}
  // victim panics and buys at elevated price
  await new Promise(r=>setTimeout(r,600));
  addTrade('buy',1000,+(105.5).toFixed(2),'Alice');
  log('‚ö†Ô∏è Spoof discovered: regulators reveal manipulation ‚Äî company valuation collapses');
  // bankruptcy event
  await new Promise(r=>setTimeout(r,600));
  log('üí• Company X goes bankrupt. Alice loses her investment.');
  // reflect in charts (mass sells)
  for(let i=0;i<8;i++){await new Promise(r=>setTimeout(r,160)); addTrade('sell',200,+(95 - i*0.6).toFixed(2),'Market');
  }
});

// initialize with a few warm-up trades
for(let i=0;i<6;i++){addTrade(i%2? 'buy':'sell',50,randPrice(),'Market');}
</script>
</body>
</html>
